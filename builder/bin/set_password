#!/usr/bin/env Rscript
source("/usr/local/lib/shiny.R")

"Usage:
  set_password <user> [<password>]"-> USAGE

set_password <- function(user, password = NULL) {
  vault_root <- Sys.getenv("VAULT_ROOT")
  password <- password %||% trimws(getPass::getPass("Password: "))
  vault_path <- sprintf("%s/users/%s", vault_root, user)

  dest <- tempfile()
  tmp <- system3("htpasswd", c("-cbB", dest, user, password),
                 check = TRUE, output = FALSE)
  value <- readLines(dest)
  unlink(dest)

  vault <- vault_client()
  vault$write(vault_path, list(password = value))
}


main <- function() {
  args <- docopt::docopt(USAGE)
  set_password(args$user, args$password)
}


main()
