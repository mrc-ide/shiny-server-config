#!/usr/bin/env Rscript
source("/usr/local/lib/shiny.R")


build_vault_env_str <- function(dat) {
  if (is.null(dat$vault)) {
    return(character())
  }

  address <- dat$vault$address
  root <- dat$vault$root %||% "/secret/shiny"

  gh_token <- Sys.getenv("VAULT_AUTH_GITHUB_TOKEN", "")
  if (nzchar(gh_token)) {
    message("Using GitHub token found from host environment")
  } else {
    gh_token <- trimws(readline("Enter GitHub token: "))
  }

  cl <- vaultr::vault_client("github", addr = address, gh_token = gh_token)

  ## There are two ways of getting the token out easily here, but one
  ## should be added to vault directly I think
  token <- cl$token$headers[[1]]
  ## cl$.get("/auth/token/lookup-self")$data$id

  env <- c(VAULT_ADDR = address,
           VAULTR_AUTH_METHOD = "token",
           VAULT_TOKEN = token,
           VAULT_ROOT = root)

  sprintf('%s=%s', names(env), unname(env))
}


write_vault_env <- function() {
  dat <- read_site_yml()
  env <- build_vault_env_str(dat)
  writeLines(env, ".vault")
}


write_vault_env()
